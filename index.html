<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>504ç­è‚¡ç¥¨äº¤æ˜“æ‰€ 6.0 çµ‚æ¥µç©©å®šç‰ˆ</title>
<!-- å¼•å…¥ QRCode ç”Ÿæˆå¥—ä»¶ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
    /* å°ˆæ¥­äº¤æ˜“çµ‚ç«¯æ©Ÿé…è‰² (Dark Mode) */
    :root {
        --primary: #3b82f6; --primary-dark: #2563eb;
        --success: #ff4d4f; /* å°è‚¡ç´…æ¼² */
        --danger: #00e676;  /* å°è‚¡ç¶ è·Œ */
        --warning: #f59e0b;
        --bg-color: #0d1117; --card-bg: #161b22;
        --text-main: #c9d1d9; --text-muted: #8b949e;
        --border: #30363d; --highlight: #1f6feb;
    }
    
    body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 20px; line-height: 1.6; }
    .container { max-width: 1200px; margin: auto; position: relative; }
    
    /* æ¨™é¡Œèˆ‡é ç±¤ */
    h1 { text-align: center; color: #58a6ff; font-size: 2.2rem; margin-bottom: 20px; font-weight: 800; letter-spacing: 2px; text-shadow: 0 0 10px rgba(88,166,255,0.3); }
    .nav-tabs { display: flex; gap: 10px; margin-bottom: 25px; overflow-x: auto; padding-bottom: 5px; }
    .nav-tabs button { flex: 1; min-width: 120px; padding: 15px 20px; border: 1px solid var(--border); background: var(--card-bg); cursor: pointer; font-size: 16px; font-weight: bold; border-radius: 8px; color: var(--text-muted); transition: all 0.2s; }
    .nav-tabs button:hover { background: #21262d; color: #fff; }
    .nav-tabs button.active { background: var(--highlight); color: white; border-color: var(--highlight); box-shadow: 0 0 15px rgba(31,111,235,0.4); }
    
    /* å…§å®¹å€å¡Šèˆ‡å¡ç‰‡ */
    .tab-content { display: none; animation: fadeIn 0.3s ease; }
    .tab-content.active { display: block; }
    .card { background: var(--card-bg); padding: 25px; border-radius: 12px; border: 1px solid var(--border); box-shadow: 0 8px 24px rgba(0,0,0,0.5); margin-bottom: 25px; }
    h3 { color: #58a6ff; margin-top: 0; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 20px; display: inline-block;}
    h4 { color: #e6edf3; margin-bottom: 15px; border-left: 4px solid var(--highlight); padding-left: 10px; }
    
    /* è¡¨å–®å…ƒä»¶ */
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .form-group { display: flex; flex-direction: column; }
    label { font-weight: bold; margin-bottom: 8px; color: var(--text-muted); font-size: 0.95rem; }
    input, select, textarea { padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 16px; background-color: #010409; color: var(--text-main); transition: border-color 0.2s; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--highlight); box-shadow: 0 0 0 2px rgba(31,111,235,0.3); }
    
    /* æŒ‰éˆ• */
    .btn { padding: 10px 20px; border: none; border-radius: 6px; font-size: 15px; font-weight: bold; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-primary { background: var(--highlight); color: white; }
    .btn-primary:hover { background: #388bfd; }
    .btn-success { background: #2ea043; color: white; }
    .btn-warning { background: #d29922; color: white; }
    .btn-danger { background: #f85149; color: white; }
    .btn-info { background: #8957e5; color: white; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
    .btn-outline:hover { background: var(--border); }
    .btn-block { width: 100%; margin-top: 15px; }
    
    /* è¡¨æ ¼ */
    .table-responsive { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; background: var(--card-bg); white-space: nowrap; }
    th, td { padding: 12px 15px; text-align: center; border-bottom: 1px solid var(--border); }
    th { background-color: #010409; font-weight: bold; color: var(--text-muted); font-size: 0.9rem; }
    tbody tr:hover { background-color: #21262d; }
    
    /* æ¼²è·Œæ¨™ç¤º */
    .text-up { color: var(--success); font-weight: bold; text-shadow: 0 0 5px rgba(255,77,79,0.3); }
    .text-down { color: var(--danger); font-weight: bold; text-shadow: 0 0 5px rgba(0,230,118,0.3); }
    .text-neutral { color: var(--text-muted); }
    
    /* æ‹–æ›³åˆ†çµ„ */
    .dnd-container { display: flex; flex-direction: column; gap: 20px; }
    .dnd-pool { padding: 15px; background: #010409; border: 2px dashed var(--border); border-radius: 8px; min-height: 80px; display: flex; flex-wrap: wrap; gap: 10px; }
    .dnd-pool.drag-over { border-color: var(--highlight); background: rgba(31,111,235,0.1); }
    .dnd-groups-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
    .group-zone { background: #1c2128; border: 1px solid var(--border); border-radius: 8px; padding: 10px; min-height: 120px; display: flex; flex-direction: column; }
    .group-zone.drag-over { border-color: var(--highlight); box-shadow: 0 0 8px rgba(31,111,235,0.3); }
    .group-zone h5 { margin: 0 0 10px 0; color: var(--text-muted); text-align: center; font-size: 1rem; }
    .student-pill { background: var(--card-bg); border: 1px solid var(--border); padding: 5px 12px; border-radius: 20px; font-size: 0.9rem; cursor: grab; user-select: none; transition: transform 0.1s; }
    .student-pill:active { cursor: grabbing; transform: scale(0.95); }
    
    /* æ¥µé€Ÿç”³è³¼é¢æ¿ */
    .buyer-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; max-height: 200px; overflow-y: auto; padding-right: 5px;}
    .buyer-btn { background: #010409; border: 1px solid var(--border); color: var(--text-main); padding: 10px 5px; border-radius: 6px; cursor: pointer; text-align: center; font-size: 0.9rem; transition: all 0.1s; }
    .buyer-btn:hover { background: #21262d; border-color: var(--text-muted); }
    .buyer-btn.selected { background: var(--highlight); color: white; border-color: var(--highlight); font-weight: bold; }
    .buyer-btn.has-trades { border-bottom: 3px solid #d29922; }
    
    .trade-panel { background: #010409; border: 1px solid var(--border); border-radius: 10px; padding: 20px; margin-top: 15px; display: none; }
    .stock-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
    .stock-btn { padding: 15px; border: 1px solid var(--border); border-radius: 8px; background: var(--card-bg); color: var(--text-main); cursor: pointer; font-size: 1.1rem; font-weight: bold; transition: 0.2s; }
    .stock-btn:hover { border-color: var(--highlight); background: #21262d; }
    .stock-btn.active { background: #238636; color: white; border-color: #2ea043; }
    
    .amount-grid { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
    .amount-btn { width: 50px; height: 50px; border-radius: 50%; background: var(--card-bg); border: 1px solid var(--border); color: white; font-size: 1.2rem; cursor: pointer; transition: 0.2s; }
    .amount-btn:hover { background: var(--highlight); border-color: var(--highlight); }
    
    .trade-badge { display: inline-flex; align-items: center; background: #21262d; border: 1px solid var(--border); border-radius: 4px; padding: 2px 8px; margin: 2px; font-size: 0.85rem; }
    .trade-badge span { margin-right: 5px; }
    .trade-badge button { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1rem; padding: 0 2px; }
    .trade-badge button:hover { color: var(--danger); }

    /* Modal é€šç”¨ */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 9000; backdrop-filter: blur(4px); }
    .modal { background: var(--card-bg); border: 1px solid var(--border); padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.8); animation: scaleUp 0.2s; max-height: 90vh; overflow-y: auto;}
    .modal h2 { margin-top: 0; color: #e6edf3; }
    
    /* å¡ç‰‡åœ–ç‰‡æŠ½ç±¤æ¨£å¼ */
    .card-display-container { width: 100%; max-width: 280px; aspect-ratio: 2.5 / 3.5; margin: 20px auto; border-radius: 12px; overflow: hidden; position: relative; border: 3px solid var(--border); box-shadow: 0 0 20px rgba(0,0,0,0.5); background: #010409; transition: transform 0.1s; }
    .card-display-container.shaking { animation: shake 0.1s infinite; border-color: var(--warning); box-shadow: 0 0 30px rgba(245,158,11,0.6); }
    .card-display-container img { width: 100%; height: 100%; object-fit: cover; display: none; }
    .card-fallback { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center; background: linear-gradient(135deg, #1c2128 0%, #0d1117 100%); }
    .card-fallback-icon { font-size: 3rem; margin-bottom: 15px; }
    .card-fallback-title { font-size: 1.5rem; font-weight: bold; color: var(--highlight); }

    /* å­¸ç”ŸæŸ¥è©¢æ©Ÿ (Kiosk Mode) å…¨è¢å¹•é˜²å‘†æ¨£å¼ */
    #kiosk-mode { display: none; position: fixed; inset: 0; background: #0d1117; z-index: 9999; overflow-y: auto; padding: 40px; box-sizing: border-box; }
    .kiosk-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--border); padding-bottom: 20px; margin-bottom: 30px; }
    .kiosk-header h1 { margin: 0; font-size: 2.5rem; text-shadow: none; color: #e6edf3; }
    .kiosk-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
    .kiosk-btn { background: #161b22; border: 2px solid var(--border); color: #c9d1d9; padding: 25px 15px; border-radius: 12px; font-size: 1.2rem; cursor: pointer; transition: all 0.2s; text-align: center; }
    .kiosk-btn:hover { border-color: var(--highlight); background: rgba(31,111,235,0.1); transform: translateY(-3px); }
    .kiosk-stat-box { background: rgba(31,111,235,0.1); border: 1px solid var(--highlight); border-radius: 8px; padding: 15px; margin-top: 20px; text-align: center; }

    /* QR Code é¡¯ç¤ºå€ */
    #qrcode-display { display: flex; justify-content: center; background: white; padding: 20px; border-radius: 10px; margin: 20px auto; width: fit-content; }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes scaleUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 25% { transform: translate(-1px, -2px) rotate(-1deg); } 50% { transform: translate(-2px, 0px) rotate(1deg); } 75% { transform: translate(2px, 2px) rotate(0deg); } 100% { transform: translate(1px, -1px) rotate(-1deg); } }

    /* é ‚éƒ¨è·‘é¦¬ç‡ˆåˆ— */
    .top-bar { display: flex; justify-content: space-between; align-items: center; background: #010409; border: 1px solid var(--border); color: var(--text-main); padding: 12px 20px; border-radius: 8px; margin-bottom: 20px; font-family: monospace; flex-wrap: wrap; gap: 10px;}
    .top-bar .ticker { color: #58a6ff; font-weight: bold; letter-spacing: 1px; display: flex; align-items: center; gap: 10px;}
    .top-controls { display: flex; gap: 10px; flex-wrap: wrap;}
    
    .sync-status { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: var(--danger); box-shadow: 0 0 8px var(--danger); }
    .sync-status.online { background: var(--danger); } 
    .sync-status.synced { background: #00e676; animation: pulseGreen 2s infinite; } 
    
    @keyframes pulseGreen { 0% { box-shadow: 0 0 0 0 rgba(0, 230, 118, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(0, 230, 118, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 230, 118, 0); } }

</style>
</head>
<body>

<!-- ğŸŒ ä¸»æ§å°ä»‹é¢ -->
<div class="container" id="main-interface">
    <h1>ğŸ“ˆ 504ç­è‚¡ç¥¨äº¤æ˜“æ‰€ 6.0 çµ‚æ¥µç©©å®šç‰ˆ</h1>
    
    <div class="top-bar">
        <span class="ticker">
            <span id="sync-indicator" class="sync-status"></span>
            <span id="sync-text"> STATUS: å–®æ©Ÿç³»çµ±å·²å•Ÿå‹•ï¼Œé›²ç«¯é€£ç·šåµæ¸¬ä¸­...</span>
        </span>
        <div class="top-controls">
            <button class="btn btn-warning" style="padding: 5px 15px; color:#000;" onclick="window.openQRModal()">ğŸ“± ç”¢ç”Ÿå­¸ç”Ÿ QR Code</button>
            <button class="btn btn-info" style="padding: 5px 15px;" onclick="window.openMarketDashboard()">ğŸ“Š å¤§ç›¤å³æ™‚çœ‹æ¿</button>
            <button class="btn btn-primary" style="padding: 5px 15px;" onclick="window.toggleKioskMode(true)">ğŸ§‘â€ğŸ“ é€²å…¥æŸ¥è©¢æ©Ÿ</button>
            <button class="btn btn-outline" style="padding: 5px 10px; font-size: 0.85rem;" onclick="window.confirmResetMonth()">ğŸ”„ é‡ç½®æœˆä»½</button>
        </div>
    </div>

    <div class="nav-tabs">
        <button class="active" onclick="window.switchTab('roster', this)">âš™ï¸ åå–®èˆ‡åˆ†çµ„</button>
        <button onclick="window.switchTab('buy', this)">âš¡ æ¥µé€Ÿç”³è³¼çµ‚ç«¯</button>
        <button onclick="window.switchTab('weekly', this)">ğŸ“Š çµç®—èµ°å‹¢èˆ‡æŠ½ç±¤</button>
        <button onclick="window.switchTab('monthly', this)">ğŸ’° æœˆåº•åˆ†ç´…è¨ˆç®—</button>
    </div>

    <!-- 1. åå–®è¨­å®šå€ -->
    <div id="roster" class="tab-content active">
        <div class="card">
            <div style="display:flex; justify-content: space-between; align-items: center;">
                <h3>ç­ç´šåå–®èˆ‡çµ„åˆ¥è¨­å®š</h3>
                <button class="btn btn-outline" onclick="window.openBulkEditModal()">ğŸ“ æ‰¹é‡è²¼ä¸Šåå–®</button>
            </div>
            <p style="color:var(--text-muted); font-size:0.9rem;">æç¤ºï¼šè«‹ç›´æ¥å°‡å­¸ç”Ÿæ‹–æ›³è‡³å°æ‡‰çš„å°çµ„å…§è‡ªå‹•å„²å­˜ã€‚</p>
            <div class="dnd-container">
                <div>
                    <h4>æœªåˆ†çµ„åå–®</h4>
                    <div id="unassigned-pool" class="dnd-pool" ondrop="window.drop(event, '')" ondragover="window.allowDrop(event)"></div>
                </div>
                <h4>å°çµ„åˆ†å€</h4>
                <div class="dnd-groups-grid" id="groups-grid"></div>
            </div>
        </div>
        
        <!-- å‚™ä»½èˆ‡é‚„åŸå€å¡Š -->
        <div class="card" style="margin-top: 25px;">
            <h3>ğŸ’¾ è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ (æ‰‹å‹•)</h3>
            <p style="color:var(--text-muted); font-size:0.9rem;">ç‚ºé˜²æ­¢æ„å¤–ï¼Œæ‚¨å¯ä»¥å°‡ç›®å‰çš„äº¤æ˜“æ‰€æ‰€æœ‰è³‡æ–™ä¸‹è¼‰ç‚ºå‚™ä»½æª”ï¼Œæˆ–å¾å‚™ä»½æª”é‚„åŸã€‚</p>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="window.exportBackup()">ğŸ“¥ åŒ¯å‡ºè³‡æ–™ (ä¸‹è¼‰å‚™ä»½ JSON)</button>
                <label class="btn btn-warning" style="cursor: pointer; margin: 0; display: inline-flex; align-items: center; justify-content: center; font-weight: bold;">
                    ğŸ“¤ åŒ¯å…¥è³‡æ–™ (é¸æ“‡å‚™ä»½é‚„åŸ)
                    <input type="file" accept=".json" style="display: none;" onchange="window.importBackup(event)">
                </label>
            </div>
        </div>
    </div>

    <!-- 2. æ¥µé€Ÿè‚¡ç¥¨ç”³è³¼å€ -->
    <div id="buy" class="tab-content">
        <div class="card">
            <h3>âš¡ æ¥µé€Ÿç”³è³¼çµ‚ç«¯</h3>
            <p style="font-size: 0.9rem; color: var(--text-muted);">1. é¸æ“‡å­¸ç”Ÿ â” 2. é¸æ“‡æ¨™çš„ â” 3. é»æ“Šå¼µæ•¸ç›´æ¥è²·å…¥ã€‚</p>
            
            <h4>1. é¸æ“‡è²·å®¶ (é»ƒç·šä»£è¡¨å·²äº¤æ˜“)</h4>
            <div id="buyer-grid" class="buyer-grid"></div>

            <div id="trade-panel" class="trade-panel">
                <h4 style="color:#58a6ff; border-left-color: #58a6ff;">2. æ­£åœ¨ç‚º <span id="current-buyer-name" style="color:white; font-size:1.2rem; margin:0 5px;">---</span> æ“ç›¤</h4>
                <div style="font-size: 0.85rem; color:var(--text-muted); margin-bottom: 10px;">
                    é¡åº¦ç‹€æ…‹ï¼šå°çµ„è‚¡ç¥¨ (å·²ç”¨ <span id="quota-group" style="color:#fff;">0</span>/5) | 00504 å¤§ç›¤ (å·²ç”¨ <span id="quota-etf" style="color:#fff;">0</span>/1)
                </div>
                
                <div class="stock-grid" id="fast-stock-grid">
                    <button class="stock-btn" onclick="window.selectFastStock('1')">ç¬¬ 1 çµ„</button>
                    <button class="stock-btn" onclick="window.selectFastStock('2')">ç¬¬ 2 çµ„</button>
                    <button class="stock-btn" onclick="window.selectFastStock('3')">ç¬¬ 3 çµ„</button>
                    <button class="stock-btn" onclick="window.selectFastStock('4')">ç¬¬ 4 çµ„</button>
                    <button class="stock-btn" onclick="window.selectFastStock('5')">ç¬¬ 5 çµ„</button>
                    <button class="stock-btn" onclick="window.selectFastStock('6')">ç¬¬ 6 çµ„</button>
                    <button class="stock-btn" onclick="window.selectFastStock('7')">ç¬¬ 7 çµ„</button>
                    <button class="stock-btn" style="border-color:#d29922; color:#d29922;" onclick="window.selectFastStock('00504')">00504 ETF</button>
                </div>

                <div id="amount-selector" style="display:none; text-align:center; padding-top:10px; border-top: 1px solid var(--border);">
                    <h5 style="margin:0 0 10px 0; color:var(--text-main);">3. é»æ“Šå¼µæ•¸ç«‹å³ä¸‹å–®</h5>
                    <div class="amount-grid">
                        <button class="amount-btn" onclick="window.executeFastBuy(1)">1</button>
                        <button class="amount-btn" onclick="window.executeFastBuy(2)">2</button>
                        <button class="amount-btn" onclick="window.executeFastBuy(3)">3</button>
                        <button class="amount-btn" onclick="window.executeFastBuy(4)">4</button>
                        <button class="amount-btn" onclick="window.executeFastBuy(5)">5</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h4>å³æ™‚ç”³è³¼ç¸½è¡¨</h4>
            <div class="table-responsive">
                <table id="portfolio-table">
                    <thead><tr><th>åº§è™Ÿå§“å</th><th>æ‰€å±¬çµ„åˆ¥</th><th>æŒæœ‰éƒ¨ä½ (é»æ“Šâœ–æ’¤éŠ·)</th><th>ç¸½æŠ•å…¥æœ¬é‡‘</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 3. é€±æœ«çµç®—å€ -->
    <div id="weekly" class="tab-content">
        <div class="card">
            <h3>ğŸ“Š é€±æœ«è‚¡åƒ¹çµç®—åˆ†æ</h3>
            <p style="color:var(--text-muted); font-size:0.9rem;">æœ¬é€±å¿…å°‡é¢è‡¨æŒ‘æˆ°ï¼è«‹é€éè¼ªç›¤æŠ½å‡ºä¸‹é€±çš„é å‘Šäº‹ä»¶ï¼Œä¸¦æ‰‹å‹•è¨­å®šæœ¬é€±çµç®—çµæœã€‚</p>
            
            <div class="form-grid" style="grid-template-columns: 2fr 1fr;">
                <div class="form-group" style="grid-column: span 2;">
                    <label>æœ¬é€±çµç®—äº‹ä»¶ (è«‹æ‰‹å‹•é¸æ“‡ã€Œä¸Šé€±ã€æŠ½å‡ºçš„é å‘Šå¡ç‰‡)ï¼š</label>
                    <div style="display: flex; gap: 10px;">
                        <!-- çµç®—é¸å–®èˆ‡æŠ½å¡å®Œå…¨ç¨ç«‹ï¼Œä¸å†é€£å‹•è¦†è“‹ -->
                        <select id="event-card" style="flex:1; font-weight:bold; color:var(--warning); background:#21262d;"></select>
                        <button class="btn btn-warning" onclick="window.openDrawModal()" style="font-size: 1.1rem; padding: 10px 25px;">ğŸ² æŠ½å–ä¸‹é€±å¡ç‰‡</button>
                    </div>
                </div>
            </div>

            <h4>è¼¸å…¥å„çµ„æœ¬é€±ç¸½åˆ†</h4>
            <div id="weekly-scores-grid" class="form-grid" style="grid-template-columns: repeat(4, 1fr); gap:10px;"></div>
            
            <button class="btn btn-primary btn-block" onclick="window.previewWeeklyPrice()">ğŸ” é‹ç®—æœ¬é€±èµ°å‹¢ (é è¦½)</button>
        </div>

        <div class="card" id="weekly-preview-card" style="display: none;">
            <h4>æœ¬é€±è‚¡åƒ¹è®Šå‹•æ’è¡Œ (ä¾ç¸½åˆ†æ’åº)</h4>
            <div class="table-responsive">
                <table id="price-table">
                    <thead><tr><th>åæ¬¡</th><th>çµ„åˆ¥</th><th>æœ¬é€±ç¸½åˆ†</th><th>åŸè‚¡åƒ¹</th><th>æ¼²è·Œå¹…</th><th>æœ€æ–°è‚¡åƒ¹</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <button class="btn btn-success btn-block" style="margin-top: 20px;" onclick="window.confirmWeeklyApply()">âœ… ç¢ºèªæ”¶ç›¤ (å„²å­˜ç´€éŒ„)</button>
        </div>
    </div>

    <!-- 4. æœˆåº•åˆ†ç´…å€ -->
    <div id="monthly" class="tab-content">
        <div class="card">
            <h3>ğŸ’° æœˆåº•ç²åˆ©å¤§çµç®—</h3>
            <div class="form-group" style="margin-bottom: 20px; background: rgba(210,153,34,0.1); padding: 15px; border-radius: 8px; border-left: 4px solid var(--warning);">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; color:#e6edf3; margin:0;">
                    <input type="checkbox" id="bumper-harvest" style="width: 20px; height: 20px;">
                    ğŸ‰ è‹¥æœ¬å­£æ›¾æŠ½ä¸­ã€00504 åŸºé‡‘å¤§è±æ”¶ã€‘ï¼Œè«‹æ‰“å‹¾ (æŒæœ‰ 00504 è€…é¡å¤–ç™¼æ”¾ $1000 è‚¡æ¯)
                </label>
            </div>
            <h4>è¼¸å…¥å„çµ„ã€æœ¬æœˆç´¯è¨ˆç¸½åˆ†ã€‘(çµç®—è‚¡æ¯ç”¨)</h4>
            <div id="monthly-scores-grid" class="form-grid" style="grid-template-columns: repeat(4, 1fr); gap:10px;"></div>
            <button class="btn btn-primary btn-block" onclick="window.calculateMonthly()">ğŸ’» åŸ·è¡Œé‹ç®—ä¸¦ç”¢å‡ºå ±è¡¨</button>
        </div>

        <div class="card" id="monthly-result-card" style="display: none;">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="margin:0;">å€‹äººçµç®—å ±è¡¨</h4>
                <button class="btn btn-outline" onclick="window.exportCSV()">ğŸ“Š åŒ¯å‡º CSV</button>
            </div>
            <div class="table-responsive">
                <table id="final-table">
                    <thead><tr><th>åº§è™Ÿ</th><th>å§“å</th><th>é€€é‚„æœ¬åˆ©å’Œ</th><th>é ˜å–è‚¡æ¯</th><th>ç¶“ç‡Ÿçé‡‘</th><th>ğŸ‘‘ ç¸½æ‹¿å›é‡‘é¡</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ================= ğŸ§‘â€ğŸ“ å­¸ç”ŸæŸ¥è©¢æ©Ÿ (Kiosk Mode) ================= -->
<div id="kiosk-mode">
    <div class="kiosk-header">
        <h1>ğŸ§‘â€ğŸ“ å€‹äººè³‡ç”¢åº«å­˜æŸ¥è©¢</h1>
        <button id="kiosk-exit-btn" class="btn btn-outline" style="background:#0d1117; color:#58a6ff; border-color:#58a6ff;" onclick="window.toggleKioskMode(false)">ğŸ”™ é—œé–‰ä¸¦è¿”å›ä¸»æ§å°</button>
    </div>
    <p style="color:var(--text-muted); font-size:1.1rem; text-align:center; margin-bottom: 30px;">è«‹é»æ“Šæ‚¨çš„å§“åï¼ŒæŸ¥çœ‹æ‚¨ç›®å‰çš„è­‰åˆ¸å¸³æˆ¶èˆ‡æœªå¯¦ç¾æç›Šã€‚</p>
    <div class="kiosk-grid" id="kiosk-student-grid"></div>
</div>

<!-- ================= å½ˆè·³è¦–çª—å€ (Modals) ================= -->
<div class="modal-overlay" id="qr-modal">
    <div class="modal" style="text-align:center;">
        <h2 style="color:var(--warning);">ğŸ“± å­¸ç”Ÿè‡ªåŠ©æƒæå€</h2>
        <p style="color:var(--text-muted);">è«‹å­¸ç”Ÿä½¿ç”¨å¹³æ¿æƒæä¸‹æ–¹ QR Codeï¼Œå³æœƒè‡ªå‹•é€²å…¥ã€Œå€‹äººåº«å­˜æŸ¥è©¢ç•«é¢ã€ã€‚</p>
        <div id="qrcode-display"></div>
        <button class="btn btn-outline btn-block" style="margin-top:20px;" onclick="window.closeModal('qr-modal')">é—œé–‰</button>
    </div>
</div>

<div class="modal-overlay" id="bulk-edit-modal">
    <div class="modal">
        <h2>æ‰¹é‡è²¼ä¸Šåå–®</h2>
        <p style="color:var(--text-muted); font-size:0.9rem;">æ¯è¡Œä¸€å€‹åå­—ï¼Œç³»çµ±å°‡è‡ªå‹•ä¾åºåˆ†é…ç‚º 1~27 è™Ÿã€‚</p>
        <textarea id="bulk-names-input" rows="12" style="width: 100%; box-sizing: border-box; resize: vertical; margin-bottom: 15px;"></textarea>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1;" onclick="window.saveBulkNames()">ğŸ’¾ å„²å­˜åå–®</button>
            <button class="btn btn-outline" style="flex:1;" onclick="window.closeModal('bulk-edit-modal')">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="dashboard-modal">
    <div class="modal" style="max-width: 700px;">
        <h2 style="color:var(--warning);">ğŸ“ˆ äº¤æ˜“æ‰€å¤§ç›¤è¡Œæƒ…</h2>
        <p style="color:var(--text-muted);">é¡¯ç¤ºå„æ¨™çš„ç›®å‰æœ€æ–°è‚¡åƒ¹èˆ‡ã€Œå‰ä¸€é€±ã€çµç®—çš„æ¼²è·Œé»æ•¸ã€‚</p>
        <div class="table-responsive">
            <table id="dashboard-table">
                <thead><tr><th>è‚¡ç¥¨æ¨™çš„</th><th>å‰é€±æ¼²è·Œé»æ•¸</th><th>å³æ™‚ç¾åƒ¹</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <button class="btn btn-outline btn-block" style="margin-top:20px;" onclick="window.closeModal('dashboard-modal')">é—œé–‰çœ‹æ¿</button>
    </div>
</div>

<div class="modal-overlay" id="student-portfolio-modal" style="z-index: 10000;">
    <div class="modal" style="max-width: 600px;">
        <h2 id="sp-name" style="color:var(--highlight); text-align:center;">å§“å</h2>
        <div class="table-responsive">
            <table id="sp-table">
                <thead><tr><th>æŒæœ‰æ¨™çš„</th><th>å¼µæ•¸</th><th>è³¼å…¥æˆæœ¬</th><th>ç›®å‰ç¾å€¼</th><th>æœªå¯¦ç¾æç›Š</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="kiosk-stat-box">
            <h3 style="margin:0 0 10px 0; color:#e6edf3;">è³‡ç”¢ç¸½è¦½</h3>
            <div style="display:flex; justify-content: space-around; font-size:1.1rem;">
                <div>ç¸½æŠ•å…¥æˆæœ¬<br><b id="sp-cost" style="color:var(--text-muted);">0</b></div>
                <div>ç›®å‰ç¸½å¸‚å€¼<br><b id="sp-value" style="color:white;">0</b></div>
                <div>ç¸½å ±é…¬ç‡<br><b id="sp-roi">0%</b></div>
            </div>
        </div>
        <button class="btn btn-primary btn-block" style="margin-top:20px;" onclick="window.closeModal('student-portfolio-modal')">ç¢ºèªä¸¦é›¢é–‹</button>
    </div>
</div>

<div class="modal-overlay" id="draw-modal">
    <div class="modal" style="text-align:center; max-width: 450px;">
        <h2>ğŸƒ ä¸‹é€±å‘½é‹äº‹ä»¶å¡</h2>
        <p style="color:var(--text-muted); margin-bottom: 15px;">é å‘Šä¸‹é€±å¸‚å ´å‹•æ…‹ï¼Œè«‹æ‰€æœ‰æŠ•è³‡äººæ³¨æ„ï¼</p>
        
        <div id="card-display-container" class="card-display-container">
            <img id="card-img-display" src="" alt="äº‹ä»¶å¡">
            <div id="card-fallback" class="card-fallback">
                <div id="card-fallback-icon" class="card-fallback-icon">â“</div>
                <div id="card-fallback-title" class="card-fallback-title">æº–å‚™æŠ½å¡</div>
            </div>
        </div>

        <button id="draw-btn" class="btn btn-warning btn-block" style="font-size:1.2rem; padding:15px;" onclick="window.startDraw()">ğŸ° é–‹å§‹æŠ½å¡</button>
        <button id="close-draw-btn" class="btn btn-outline btn-block" style="margin-top:10px;" onclick="window.closeModal('draw-modal')">é—œé–‰</button>
    </div>
</div>

<div class="modal-overlay" id="custom-modal" style="z-index: 10001;">
    <div class="modal" style="text-align:center; max-width:400px;">
        <h2 id="modal-title">æç¤ºè¨Šæ¯</h2>
        <p id="modal-desc" style="margin-bottom: 25px;"></p>
        <button class="btn btn-primary" onclick="window.closeModal('custom-modal')" style="min-width: 120px;">ç¢ºå®š</button>
    </div>
</div>

<!-- ================= æ ¸å¿ƒå–®æ©Ÿé‚è¼¯å€ (ä¿è­‰ UI 100% å¯é‹ä½œ) ================= -->
<script>
    const ALL_18_CARDS = [
        { id: 1, name: '1.ã€å¤§ç‰›å¸‚ä¾†è‡¨ã€‘å¤šæ•¸ä¸Šæ¼²', effect: 'bull', img: './cards/1.jpg' },
        { id: 2, name: '2.ã€å¤§ç†Šå¸‚ä¾†è¥²ã€‘å¤šæ•¸ä¸‹è·Œ', effect: 'bear', img: './cards/2.jpg' },
        { id: 3, name: '3.ã€åœ‹å®‰åŸºé‡‘é€²å ´ã€‘è·Œå¹…ç‚ºé›¶', effect: 'nsf', img: './cards/3.jpg' },
        { id: 4, name: '4.ã€ç†±éŒ¢æ¹§å…¥å°è‚¡ã€‘æ¼²å¹…åŠ å€', effect: 'hot', img: './cards/4.jpg' },
        { id: 5, name: '5.ã€ç¶“æ¿Ÿé€šç¸®è¡°é€€ã€‘è·Œå¹…åŠ å€', effect: 'deflation', img: './cards/5.jpg' },
        { id: 6, name: '6.ã€00504 åŸºé‡‘å¤§è±æ”¶ã€‘', effect: 'narrative', img: './cards/6.jpg' }, 
        { id: 7, name: '7.ã€è³‡é‡‘é›†ä¸­ç‰¹å®šç”¢æ¥­ã€‘åƒ…å‰2åæ¼²', effect: 'concentrate', img: './cards/7.jpg' },
        { id: 8, name: '8.ã€è²¡å ±åœ°é›·ã€‘ä½œæ¥­é²äº¤é›™å€æ‰£åˆ†', effect: 'narrative', img: './cards/8.jpg' },
        { id: 9, name: '9.ã€å…¬è¡›å±æ©Ÿã€‘æ•´æ½”ç¼ºå¤±é›™å€æ‰£åˆ†', effect: 'narrative', img: './cards/9.jpg' }, 
        { id: 10, name: '10.ã€å°ˆåˆ©ç ”ç™¼å­£ã€‘ç™¼è¨€é›™å€åŠ åˆ†', effect: 'narrative', img: './cards/10.jpg' },
        { id: 11, name: '11.ã€å°ˆæ³¨æ–¼ç ”ç™¼æ•ˆç‡ã€‘å„ªè³ªçµ„é¡å¤–+500å…ƒ', effect: 'narrative', img: './cards/11.jpg' },
        { id: 12, name: '12.ã€è¡Œæ”¿æ•ˆç‡ç¨½æŸ¥ã€‘é½Šäº¤å›æ¢ç¸½åˆ†+5', effect: 'narrative', img: './cards/12.jpg' },
        { id: 13, name: '13.ã€ç”¢èƒ½æ»¿è¼‰ã€‘ç„¡é²åˆ°çµ„é¡å¤–+500å…ƒ', effect: 'narrative', img: './cards/13.jpg' },
        { id: 14, name: '14.ã€å„ªè‰¯è²¡å ±è¡¨æšã€‘ä½œæ¥­å„ªè‰¯é›™å€åŠ åˆ†', effect: 'narrative', img: './cards/14.jpg' },
        { id: 15, name: '15.ã€å¸‚å ´äº¤æ˜“å†·æ¸…ã€‘æ¼²è·Œåœç¸®æ°´ç‚ºÂ±300', effect: 'wait', img: './cards/15.jpg' },
        { id: 16, name: '16.ã€è­‰äº¤ç¨…èª¿æ¼²ã€‘å¤§æ–¼2000å…ƒè€…æ‰£200ç¨…é‡‘', effect: 'tax', img: './cards/16.jpg' },
        { id: 17, name: '17.ã€ETFç¶“ç†äººæ›å°‡ã€‘ç›²æŠ½ä¸€çµ„å–ä»£å¤§ç›¤', effect: 'etf_change', img: './cards/17.jpg' },
        { id: 18, name: '18.ã€æˆåˆ†è‚¡æ¬Šé‡èª¿æ•´ã€‘æœ€å·®çµ„å–ä»£å¤§ç›¤', effect: 'etf_risk', img: './cards/18.jpg' }
    ];

    const MAX_STUDENTS = 27;
    const GROUPS_COUNT = 7;
    const INITIAL_PRICE = 2000;

    window.db = { students: [], stockPrices: {}, lastWeekChanges: {}, transactions: [] };
    window.currentFastBuyerId = null; 
    window.currentFastStockId = null;
    let drawInterval;

    // --- éŸ³æ•ˆå¼•æ“ (ç„¡é ˆå¤–æ›æª”æ¡ˆ) ---
    let audioCtx = null;
    function initAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }
    
    window.playTickSound = function() {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(1000, audioCtx.currentTime); 
        osc.frequency.exponentialRampToValueAtTime(500, audioCtx.currentTime + 0.05);
        gain.gain.setValueAtTime(0.15, audioCtx.currentTime); 
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.05);
    };
    
    window.playTadaSound = function() {
        if (!audioCtx) return;
        const osc1 = audioCtx.createOscillator(); const osc2 = audioCtx.createOscillator(); const osc3 = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc1.type = 'triangle'; osc2.type = 'triangle'; osc3.type = 'triangle';
        osc1.frequency.setValueAtTime(523.25, audioCtx.currentTime); 
        osc2.frequency.setValueAtTime(659.25, audioCtx.currentTime); 
        osc3.frequency.setValueAtTime(783.99, audioCtx.currentTime); 
        gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.5);
        osc1.connect(gain); osc2.connect(gain); osc3.connect(gain); gain.connect(audioCtx.destination);
        osc1.start(); osc2.start(); osc3.start();
        osc1.stop(audioCtx.currentTime + 1.5); osc2.stop(audioCtx.currentTime + 1.5); osc3.stop(audioCtx.currentTime + 1.5);
    };

    // --- æ ¸å¿ƒ UI å‡½æ•¸ (çµ•å°è·¯å¾‘é˜²å‘†) ---
    function initDropdown() {
        const select = document.getElementById('event-card');
        select.innerHTML = '';
        ALL_18_CARDS.forEach(c => { select.innerHTML += `<option value="${c.effect}">${c.name}</option>`; });
        window.renderScoreInputs('weekly-scores-grid', 'weekly-score');
        window.renderScoreInputs('monthly-scores-grid', 'monthly-score');
    }

    window.switchTab = function(tabId, btnElement) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-tabs button').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        if (btnElement) btnElement.classList.add('active');
        if (tabId === 'buy') window.renderFastBuyerGrid(); 
    };

    window.showModal = function(title, desc) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-desc').innerText = desc;
        document.getElementById('custom-modal').style.display = 'flex';
    };

    window.closeModal = function(modalId) { document.getElementById(modalId).style.display = 'none'; };
    window.formatMoney = function(num) { return '$' + num.toLocaleString('en-US'); };
    window.getStockName = function(stockId) { return stockId === '00504' ? '00504 å¤§ç›¤' : `ç¬¬${stockId}çµ„`; };

    // è³‡æ–™å‚™ä»½é‚„åŸ
    window.exportBackup = function() {
        const dataStr = JSON.stringify(window.db, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const dateStr = new Date().toISOString().split('T')[0];
        a.href = url;
        a.download = `504ç­è‚¡ç¥¨äº¤æ˜“æ‰€_å‚™ä»½_${dateStr}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    window.importBackup = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedDb = JSON.parse(e.target.result);
                if (importedDb && importedDb.students && importedDb.stockPrices) {
                    window.db = importedDb;
                    window.saveDataToCloud(); 
                    window.updateAllUI(); 
                    window.showModal('é‚„åŸæˆåŠŸ', 'è³‡æ–™å·²æˆåŠŸé‚„åŸï¼');
                } else {
                    window.showModal('æ ¼å¼éŒ¯èª¤', 'ä¸Šå‚³çš„æª”æ¡ˆä¸æ˜¯æœ‰æ•ˆçš„å‚™ä»½æª”ã€‚');
                }
            } catch (err) {
                window.showModal('è§£æéŒ¯èª¤', 'æª”æ¡ˆè§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ˜¯å¦ææ¯€ã€‚');
            }
        };
        reader.readAsText(file);
        event.target.value = ''; 
    };

    window.openMarketDashboard = function() {
        const tbody = document.querySelector('#dashboard-table tbody');
        tbody.innerHTML = '';
        const keys = ['1','2','3','4','5','6','7','00504'];
        keys.forEach(k => {
            let price = window.db.stockPrices[k] || INITIAL_PRICE;
            let change = window.db.lastWeekChanges[k] || 0;
            let changeStr = change === 0 ? '<span class="text-neutral">â€” 0</span>' : (change > 0 ? `<span class="text-up">â–² +${change}</span>` : `<span class="text-down">â–¼ ${change}</span>`); 
            tbody.innerHTML += `<tr><td style="font-weight:bold;">${window.getStockName(k)}</td><td>${changeStr}</td><td style="font-size:1.2rem; color:var(--highlight); font-weight:bold;">${price}</td></tr>`;
        });
        document.getElementById('dashboard-modal').style.display = 'flex';
    };

    window.openQRModal = function() {
        const qrContainer = document.getElementById("qrcode-display");
        qrContainer.innerHTML = ""; 
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('mode', 'kiosk'); 
        new QRCode(qrContainer, { text: currentUrl.toString(), width: 220, height: 220, colorDark : "#0d1117", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H });
        document.getElementById('qr-modal').style.display = 'flex';
    };

    window.toggleKioskMode = function(isActive) {
        if (isActive) {
            document.getElementById('main-interface').style.display = 'none';
            document.getElementById('kiosk-mode').style.display = 'block';
            window.renderKioskGrid();
        } else {
            document.getElementById('kiosk-mode').style.display = 'none';
            document.getElementById('main-interface').style.display = 'block';
        }
    };

    window.renderKioskGrid = function() {
        const grid = document.getElementById('kiosk-student-grid');
        grid.innerHTML = '';
        window.db.students.filter(s => s.name !== '').forEach(st => {
            const btn = document.createElement('div');
            btn.className = 'kiosk-btn';
            btn.innerText = `${st.id}. ${st.name}`;
            btn.onclick = () => window.openStudentPortfolio(st.id);
            grid.appendChild(btn);
        });
    };

    window.openStudentPortfolio = function(studentId) {
        const st = window.db.students.find(s => s.id === studentId);
        document.getElementById('sp-name').innerText = `ğŸ“Š ${st.id}è™Ÿ ${st.name} çš„æŠ•è³‡çµ„åˆ`;
        const myTxs = window.db.transactions.filter(t => t.studentId === studentId);
        const tbody = document.querySelector('#sp-table tbody');
        tbody.innerHTML = '';
        let totalCost = 0; let totalValue = 0;

        if (myTxs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="color:var(--text-muted);">ç›®å‰å°šæœªç”³è³¼ä»»ä½•è‚¡ç¥¨</td></tr>';
        } else {
            myTxs.forEach(tx => {
                let cost = tx.amount * INITIAL_PRICE;
                let currentPrice = window.db.stockPrices[tx.stockId];
                let value = tx.amount * currentPrice;
                let profit = value - cost;
                totalCost += cost; totalValue += value;
                let profitStr = profit === 0 ? '<span class="text-neutral">0</span>' : (profit > 0 ? `<span class="text-up">â–² +${profit}</span>` : `<span class="text-down">â–¼ ${profit}</span>`);
                tbody.innerHTML += `<tr><td style="font-weight:bold;">${window.getStockName(tx.stockId)}</td><td>${tx.amount}</td><td>${cost}</td><td style="color:#fff;">${value}</td><td>${profitStr}</td></tr>`;
            });
        }
        document.getElementById('sp-cost').innerText = window.formatMoney(totalCost);
        document.getElementById('sp-value').innerText = window.formatMoney(totalValue);
        let roi = totalCost > 0 ? ((totalValue - totalCost) / totalCost * 100).toFixed(1) : 0;
        let roiEl = document.getElementById('sp-roi');
        roiEl.innerText = `${roi > 0 ? '+' : ''}${roi}%`;
        roiEl.className = roi > 0 ? 'text-up' : (roi < 0 ? 'text-down' : 'text-neutral');
        document.getElementById('student-portfolio-modal').style.display = 'flex';
    };

    window.openDrawModal = function() {
        const imgEl = document.getElementById('card-img-display');
        const fallbackEl = document.getElementById('card-fallback');
        const container = document.getElementById('card-display-container');
        
        imgEl.style.display = 'none'; 
        fallbackEl.style.display = 'flex';
        document.getElementById('card-fallback-icon').innerText = 'â“';
        document.getElementById('card-fallback-title').innerText = "æº–å‚™æŠ½å¡";
        
        container.classList.remove('shaking');
        document.getElementById('draw-btn').style.display = 'block';
        document.getElementById('close-draw-btn').style.display = 'block';
        document.getElementById('draw-modal').style.display = 'flex';
    };

    window.renderCardToDisplay = function(card) {
        const imgEl = document.getElementById('card-img-display');
        const fallbackEl = document.getElementById('card-fallback');
        imgEl.style.display = 'none'; fallbackEl.style.display = 'flex';
        document.getElementById('card-fallback-icon').innerText = 'ğŸƒ';
        document.getElementById('card-fallback-title').innerText = card.name;
        imgEl.src = card.img;
        imgEl.onload = () => { imgEl.style.display = 'block'; fallbackEl.style.display = 'none'; };
    };

    window.startDraw = function() {
        initAudio(); // å•Ÿå‹•éŸ³æ•ˆå¼•æ“
        document.getElementById('draw-btn').style.display = 'none';
        document.getElementById('close-draw-btn').style.display = 'none';
        const container = document.getElementById('card-display-container');
        container.classList.add('shaking');
        
        let counter = 0; let speed = 80; 
        drawInterval = setInterval(() => {
            window.playTickSound();
            let randCard = ALL_18_CARDS[Math.floor(Math.random() * ALL_18_CARDS.length)];
            window.renderCardToDisplay(randCard);
            counter += speed;
            if (counter >= 2500) {
                clearInterval(drawInterval);
                container.classList.remove('shaking');
                let finalCard = ALL_18_CARDS[Math.floor(Math.random() * ALL_18_CARDS.length)];
                window.renderCardToDisplay(finalCard);
                window.playTadaSound(); // é–‹çæ­¡æ¨‚éŸ³æ•ˆ
                setTimeout(() => { document.getElementById('close-draw-btn').style.display = 'block'; }, 1000);
            }
        }, speed);
    };

    window.renderRosterDND = function() {
        const unassignedPool = document.getElementById('unassigned-pool');
        const groupsGrid = document.getElementById('groups-grid');
        unassignedPool.innerHTML = ''; groupsGrid.innerHTML = '';
        for (let i = 1; i <= 7; i++) groupsGrid.innerHTML += `<div class="group-zone" id="zone-${i}" ondrop="window.drop(event, '${i}')" ondragover="window.allowDrop(event)"><h5>ç¬¬ ${i} çµ„</h5></div>`;
        window.db.students.forEach(st => {
            if (!st.name) return;
            const pill = document.createElement('div');
            pill.className = 'student-pill'; pill.draggable = true; pill.id = `stu-${st.id}`; pill.innerText = `${st.id}. ${st.name}`;
            pill.ondragstart = window.drag;
            if (st.group && st.group !== '') {
                const zone = document.getElementById(`zone-${st.group}`);
                if (zone) zone.appendChild(pill);
            } else unassignedPool.appendChild(pill);
        });
    };
    window.allowDrop = function(ev) { ev.preventDefault(); ev.currentTarget.classList.add('drag-over'); };
    window.drag = function(ev) { ev.dataTransfer.setData("text", ev.target.id); };
    window.drop = function(ev, groupId) {
        ev.preventDefault();
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        const studentId = ev.dataTransfer.getData("text").replace('stu-', '');
        let student = window.db.students.find(s => s.id === studentId);
        if (student) { student.group = groupId; window.saveDataToCloud(); }
    };
    document.addEventListener('dragleave', function(ev) { if (ev.target.classList && ev.target.classList.contains('drag-over')) ev.target.classList.remove('drag-over'); });

    window.openBulkEditModal = function() {
        document.getElementById('bulk-names-input').value = window.db.students.map(s => s.name).join('\n');
        document.getElementById('bulk-edit-modal').style.display = 'flex';
    };
    window.saveBulkNames = function() {
        const lines = document.getElementById('bulk-names-input').value.split('\n');
        for (let i = 0; i < MAX_STUDENTS; i++) {
            let name = lines[i] ? lines[i].trim() : '';
            window.db.students[i].name = name;
            if(name === '') window.db.students[i].group = ''; 
        }
        window.saveDataToCloud(); window.closeModal('bulk-edit-modal');
    };

    window.renderFastBuyerGrid = function() {
        const grid = document.getElementById('buyer-grid');
        grid.innerHTML = '';
        window.db.students.filter(s => s.name !== '').forEach(st => {
            const hasTrades = window.db.transactions.some(t => t.studentId === st.id);
            const btn = document.createElement('button');
            btn.className = `buyer-btn ${hasTrades ? 'has-trades' : ''} ${window.currentFastBuyerId === st.id ? 'selected' : ''}`;
            btn.innerText = `${st.id}. ${st.name}`;
            btn.onclick = () => window.selectFastBuyer(st.id, btn);
            grid.appendChild(btn);
        });
    };
    window.selectFastBuyer = function(studentId, btnElement) {
        window.currentFastBuyerId = studentId; window.currentFastStockId = null;
        document.querySelectorAll('.buyer-btn').forEach(b => b.classList.remove('selected'));
        if(btnElement) btnElement.classList.add('selected');
        const st = window.db.students.find(s => s.id === studentId);
        document.getElementById('current-buyer-name').innerText = `${st.id}è™Ÿ ${st.name}`;
        document.querySelectorAll('.stock-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('amount-selector').style.display = 'none';
        document.getElementById('trade-panel').style.display = 'block';
        window.updateQuotaDisplay();
    };
    window.updateQuotaDisplay = function() {
        if (!window.currentFastBuyerId) return;
        const myTxs = window.db.transactions.filter(t => t.studentId === window.currentFastBuyerId);
        const groupShares = myTxs.filter(t => t.stockId !== '00504').reduce((sum, t) => sum + t.amount, 0);
        const etfShares = myTxs.filter(t => t.stockId === '00504').reduce((sum, t) => sum + t.amount, 0);
        document.getElementById('quota-group').innerText = groupShares;
        document.getElementById('quota-group').style.color = groupShares >= 5 ? 'var(--success)' : '#fff';
        document.getElementById('quota-etf').innerText = etfShares;
        document.getElementById('quota-etf').style.color = etfShares >= 1 ? 'var(--success)' : '#fff';
    };
    window.selectFastStock = function(stockId) {
        if (!window.currentFastBuyerId) return;
        window.currentFastStockId = stockId;
        const btns = document.querySelectorAll('.stock-btn');
        btns.forEach(b => b.classList.remove('active'));
        const targetBtn = Array.from(btns).find(b => { return stockId === '00504' ? b.innerText.includes('00504') : b.innerText.includes(`ç¬¬ ${stockId} çµ„`); });
        if (targetBtn) targetBtn.classList.add('active');
        document.getElementById('amount-selector').style.display = 'block';
    };
    window.executeFastBuy = function(amount) {
        if (!window.currentFastBuyerId || !window.currentFastStockId) return;
        const student = window.db.students.find(s => s.id === window.currentFastBuyerId);
        if (!student.group) return window.showModal('ç”³è³¼å¤±æ•—', 'è©²å­¸ç”Ÿå°šæœªåˆ†é…çµ„åˆ¥ï¼Œç„¡æ³•é€²è¡Œäº¤æ˜“ï¼');
        if (student.group === window.currentFastStockId) return window.showModal('è¦å‰‡é™åˆ¶', 'æ³•è¦ç¦æ­¢ç”³è³¼è‡ªå·±æ‰€å±¬çµ„åˆ¥çš„è‚¡ç¥¨ï¼');
        const myTxs = window.db.transactions.filter(t => t.studentId === window.currentFastBuyerId);
        const currentGroupShares = myTxs.filter(t => t.stockId !== '00504').reduce((sum, t) => sum + t.amount, 0);
        const currentETFShares = myTxs.filter(t => t.stockId === '00504').reduce((sum, t) => sum + t.amount, 0);
        if (window.currentFastStockId === '00504') { if (currentETFShares + amount > 1) return window.showModal('é¡åº¦ä¸è¶³', 'æ¯äººæ¯æœˆæœ€å¤šåªèƒ½ç”³è³¼ 1 å¼µ 00504 ETFã€‚'); } 
        else { if (currentGroupShares + amount > 5) return window.showModal('é¡åº¦ä¸è¶³', `æ¯äººæ¯æœˆæœ€å¤šç”³è³¼ 5 å¼µå°çµ„è‚¡ç¥¨ï¼ˆç›®å‰å·²ç”³è³¼ ${currentGroupShares} å¼µï¼‰ã€‚`); }
        
        window.db.transactions.push({ studentId: window.currentFastBuyerId, stockId: window.currentFastStockId, amount: amount, priceBought: INITIAL_PRICE });
        window.saveDataToCloud(); 
        document.querySelectorAll('.stock-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('amount-selector').style.display = 'none';
        window.currentFastStockId = null;
    };
    window.renderTransactionsMerged = function() {
        const tbody = document.querySelector('#portfolio-table tbody');
        tbody.innerHTML = '';
        window.db.students.filter(s => s.name !== '').forEach(st => {
            const myTxs = window.db.transactions.filter(t => t.studentId === st.id);
            if (myTxs.length === 0) return;
            let badges = ''; let totalInvested = 0;
            myTxs.forEach((tx) => {
                totalInvested += (tx.amount * INITIAL_PRICE);
                badges += `<span class="trade-badge"><span>${window.getStockName(tx.stockId)} x${tx.amount}</span><button title="æ’¤éŠ·" onclick="window.deleteTxMerged('${st.id}', '${tx.stockId}')">âœ–</button></span>`;
            });
            tbody.innerHTML += `<tr><td>${st.id}. ${st.name}</td><td style="color:var(--text-muted);">ç¬¬ ${st.group} çµ„</td><td style="text-align:left; max-width:300px; white-space:normal;">${badges}</td><td style="font-weight:bold;">${window.formatMoney(totalInvested)}</td></tr>`;
        });
    };
    window.deleteTxMerged = function(studentId, stockId) {
        window.db.transactions = window.db.transactions.filter(t => !(t.studentId === studentId && t.stockId === stockId));
        window.saveDataToCloud(); 
    };

    window.renderScoreInputs = function(containerId, inputClass) {
        const container = document.getElementById(containerId); container.innerHTML = '';
        for (let i = 1; i <= 7; i++) container.innerHTML += `<div class="form-group"><label>ç¬¬ ${i} çµ„ç¸½åˆ†ï¼š</label><input type="number" class="${inputClass}" data-group="${i}" placeholder="..."></div>`;
    };

    window.tempNewPrices = {}; window.tempChanges = {}; 

    window.previewWeeklyPrice = function() {
        const inputs = document.querySelectorAll('.weekly-score');
        let groupScores = []; let missing = false;
        inputs.forEach(input => {
            const score = parseInt(input.value);
            if (isNaN(score)) missing = true;
            groupScores.push({ id: input.getAttribute('data-group'), score: score, currentPrice: window.db.stockPrices[input.getAttribute('data-group')] });
        });
        if (missing) return window.showModal('è³‡æ–™æœªé½Š', 'è«‹å®Œæ•´å¡«å¯« 1~7 çµ„çš„åˆ†æ•¸æ‰èƒ½é€²è¡Œå¤§ç›¤é‹ç®—ã€‚');

        const event = document.getElementById('event-card').value; 
        let sortedScores = [...groupScores].sort((a, b) => b.score - a.score);
        let baselineIndex = 3; 
        if (event === 'bull') baselineIndex = 5; 
        if (event === 'bear') baselineIndex = 1; 
        let baselineScore = sortedScores[baselineIndex].score;
        let upMultiplier = event === 'hot' ? 100 : 50; 
        let downMultiplier = event === 'deflation' ? 100 : 50;
        let maxUpCap = 500; if (event === 'hot') maxUpCap = 1000; if (event === 'wait') maxUpCap = 300;
        let maxDownCap = -500; if (event === 'deflation') maxDownCap = -1000; if (event === 'wait') maxDownCap = -300;
        if (event === 'nsf') maxDownCap = 0; 

        let calcMap = {};
        groupScores.forEach(group => {
            let scoreDiff = group.score - baselineScore;
            let priceChange = 0;
            if (scoreDiff > 0) priceChange = Math.min(scoreDiff * upMultiplier, maxUpCap);
            else if (scoreDiff < 0) priceChange = Math.max(scoreDiff * downMultiplier, maxDownCap);
            if (event === 'concentrate') {
                let rank = sortedScores.findIndex(s => s.id === group.id) + 1;
                if (rank > 2 && priceChange > 0) priceChange = 0; 
            }
            let newPrice = group.currentPrice + priceChange;
            let taxDeducted = false;
            if (event === 'tax' && newPrice > 2000) { 
                newPrice -= 200; 
                taxDeducted = true; 
                priceChange = newPrice - group.currentPrice; 
            } 
            calcMap[group.id] = { newPrice, priceChange, scoreDiff, taxDeducted, currentPrice: group.currentPrice };
        });

        window.tempNewPrices = {}; window.tempChanges = {}; let resultRows = [];
        sortedScores.forEach((group, index) => {
            let data = calcMap[group.id];
            window.tempNewPrices[group.id] = data.newPrice; window.tempChanges[group.id] = data.priceChange;
            let changeClass = data.priceChange > 0 ? 'text-up' : (data.priceChange < 0 ? 'text-down' : 'text-neutral');
            let changeSymbol = data.priceChange > 0 ? 'â–² +' : (data.priceChange < 0 ? 'â–¼ ' : 'â€” '); 
            let taxNote = data.taxDeducted ? ' <span style="font-size:0.8rem;color:var(--warning);">(æ‰£ç¨…200)</span>' : '';
            let rankBadge = `${index + 1}`;
            if(index===0) rankBadge = 'ğŸ¥‡ 1'; if(index===1) rankBadge = 'ğŸ¥ˆ 2'; if(index===2) rankBadge = 'ğŸ¥‰ 3';
            resultRows.push(`<tr><td style="font-weight:bold;">${rankBadge}</td><td>ç¬¬ ${group.id} çµ„</td><td>${group.score} <small style="color:var(--text-muted)">(è·åŸºæº–${data.scoreDiff > 0 ? '+'+data.scoreDiff : data.scoreDiff})</small></td><td>${data.currentPrice}</td><td class="${changeClass}">${changeSymbol}${Math.abs(data.priceChange)}${taxNote}</td><td style="font-weight:bold; font-size:1.1rem; color: #fff;">${data.newPrice}</td></tr>`);
        });

        let etfCurrent = window.db.stockPrices['00504']; let etfNewPrice = 0; let etfNote = "";
        if (event === 'etf_change') { 
            let randomId = Math.floor(Math.random() * 7) + 1; 
            etfNewPrice = window.tempNewPrices[randomId.toString()]; 
            etfNote = `ç¶“ç†äººæ›å°‡ (å–®å£“ç¬¬ ${randomId} çµ„)`; 
        } else if (event === 'etf_risk') { 
            let lastGroup = sortedScores[6]; 
            etfNewPrice = window.tempNewPrices[lastGroup.id]; 
            etfNote = `æ¬Šé‡èª¿æ•´ (èˆ‡æœ€å¾Œä¸€ååŒåƒ¹)`; 
        } else { 
            let sum = Object.keys(window.tempNewPrices).reduce((acc, val) => acc + window.tempNewPrices[val], 0); 
            etfNewPrice = Math.round(sum / 7); 
            etfNote = `è¿½è¹¤å¤§ç›¤ (7çµ„å¹³å‡åƒ¹)`; 
        }

        window.tempNewPrices['00504'] = etfNewPrice; let etfChange = etfNewPrice - etfCurrent; window.tempChanges['00504'] = etfChange;
        let etfChangeClass = etfChange > 0 ? 'text-up' : (etfChange < 0 ? 'text-down' : 'text-neutral');
        let etfChangeSymbol = etfChange > 0 ? 'â–² +' : (etfChange < 0 ? 'â–¼ ' : 'â€” ');
        resultRows.push(`<tr style="background: rgba(210,153,34,0.1); border-top: 2px solid #d29922;"><td>ğŸ¯ <strong>ETF</strong></td><td style="color:#d29922; font-weight:bold;">00504</td><td style="color:var(--text-muted); font-size:0.85rem;">${etfNote}</td><td>${etfCurrent}</td><td class="${etfChangeClass}">${etfChangeSymbol}${Math.abs(etfChange)}</td><td style="font-weight:bold; font-size:1.1rem; color: #d29922;">${etfNewPrice}</td></tr>`);

        document.querySelector('#price-table tbody').innerHTML = resultRows.join('');
        document.getElementById('weekly-preview-card').style.display = 'block';
    };

    window.confirmWeeklyApply = function() {
        window.db.stockPrices = { ...window.tempNewPrices }; window.db.lastWeekChanges = { ...window.tempChanges }; 
        window.saveDataToCloud();
        document.querySelectorAll('.weekly-score').forEach(input => input.value = '');
        document.getElementById('weekly-preview-card').style.display = 'none';
        window.showModal('æ”¶ç›¤å®Œæˆ', 'æœ€æ–°è‚¡åƒ¹èˆ‡æ­·å²æ¼²è·Œé»æ•¸å·²åŒæ­¥ï¼');
    };

    window.calculateMonthly = function() {
        const inputs = document.querySelectorAll('.monthly-score'); let monthlyScores = {}; let missing = false;
        inputs.forEach(input => { const score = parseInt(input.value); if (isNaN(score)) missing = true; monthlyScores[input.getAttribute('data-group')] = score; });
        if (missing) return window.showModal('è³‡æ–™æœªé½Š', 'è«‹å¡«å¯«å®Œæ•´ 7 çµ„çš„ã€æœ¬æœˆç´¯è¨ˆç¸½åˆ†ã€‘ã€‚');
        const isBumperHarvest = document.getElementById('bumper-harvest').checked;
        let groupDividends = {}; let groupBonusPool = {}; let sumDividend = 0;
        for (let i = 1; i <= 7; i++) { let id = i.toString(); let div = monthlyScores[id] * 3; groupDividends[id] = div; sumDividend += div; groupBonusPool[id] = 0; }
        groupDividends['00504'] = Math.round(sumDividend / 7);
        if (isBumperHarvest) groupDividends['00504'] += 1000;
        window.db.transactions.forEach(tx => { if (tx.stockId !== '00504') groupBonusPool[tx.stockId] += (tx.amount * INITIAL_PRICE); });
        let finalResults = [];
        window.db.students.filter(st => st.name !== '').forEach(student => {
            let totalPrincipalAndProfit = 0; let totalDividend = 0;
            let myTx = window.db.transactions.filter(t => t.studentId === student.id);
            myTx.forEach(tx => {
                let finalPrice = window.db.stockPrices[tx.stockId];
                totalPrincipalAndProfit += (finalPrice * tx.amount);
                totalDividend += (groupDividends[tx.stockId] * tx.amount);
            });
            let managementBonus = 0;
            if (student.group) { let pool = groupBonusPool[student.group.toString()] || 0; managementBonus = Math.round((pool * 0.1) / 4); }
            finalResults.push({ id: student.id, name: student.name, group: student.group || 'ç„¡', pp: totalPrincipalAndProfit, div: totalDividend, bonus: managementBonus, total: totalPrincipalAndProfit + totalDividend + managementBonus });
        });
        let resultRows = finalResults.map(r => `<tr><td>${r.id}</td><td>${r.name} <span style="color:var(--text-muted); font-size:0.8rem;">(ç¬¬${r.group}çµ„)</span></td><td>${window.formatMoney(r.pp)}</td><td style="color:var(--success); font-weight:bold;">${window.formatMoney(r.div)}</td><td style="color:var(--warning); font-weight:bold;">${window.formatMoney(r.bonus)}</td><td style="font-weight:bold; font-size:1.15rem; color:#58a6ff; background: rgba(88,166,255,0.1);">${window.formatMoney(r.total)}</td></tr>`);
        document.querySelector('#final-table tbody').innerHTML = resultRows.join('');
        document.getElementById('monthly-result-card').style.display = 'block';
    };

    window.exportCSV = function() {
        let table = document.getElementById("final-table"); let rows = table.querySelectorAll("tr"); let csv = []; let BOM = "\uFEFF"; 
        for (let i = 0; i < rows.length; i++) {
            let row = [], cols = rows[i].querySelectorAll("td, th");
            for (let j = 0; j < cols.length; j++) { let text = cols[j].innerText.replace(/\n|\r/g, '').replace(/\$|,/g, ''); row.push(`"${text}"`); }
            csv.push(row.join(","));
        }
        let csvFile = new Blob([BOM + csv.join("\n")], {type: "text/csv;charset=utf-8;"});
        let downloadLink = document.createElement("a"); let dateStr = new Date().toISOString().split('T')[0];
        downloadLink.download = `504ç­è‚¡ç¥¨çµç®—å ±è¡¨_${dateStr}.csv`;
        downloadLink.href = window.URL.createObjectURL(csvFile); downloadLink.style.display = "none";
        document.body.appendChild(downloadLink); downloadLink.click(); document.body.removeChild(downloadLink);
    };

    window.confirmResetMonth = function() {
        if (confirm("âš ï¸ è­¦å‘Šï¼šé€™å°‡æœƒæ¸…é™¤æ‰€æœ‰çš„ç”³è³¼ç´€éŒ„ï¼Œä¸¦å°‡æ‰€æœ‰è‚¡åƒ¹é‡ç½®ç‚º $2000ã€‚\nï¼ˆå­¸ç”Ÿåå–®èˆ‡åˆ†çµ„æœƒä¿ç•™ï¼‰\n\nç¢ºå®šè¦é–‹å•Ÿæ–°æœˆä»½å—ï¼Ÿ")) {
            for (let i = 1; i <= GROUPS_COUNT; i++) { window.db.stockPrices[i.toString()] = INITIAL_PRICE; window.db.lastWeekChanges[i.toString()] = 0; }
            window.db.stockPrices['00504'] = INITIAL_PRICE; window.db.lastWeekChanges['00504'] = 0; window.db.transactions = [];
            window.saveDataToCloud();
            document.getElementById('monthly-result-card').style.display = 'none';
            document.querySelectorAll('.monthly-score').forEach(i => i.value = '');
            window.showModal('ç³»çµ±é‡ç½®', 'æ–°æœˆä»½å·²é–‹å•Ÿï¼äº¤æ˜“ç´€éŒ„å·²æ¸…ç©ºï¼Œå¤§ç›¤å›æ­¸èµ·å§‹é»ã€‚');
        }
    };

    // --- ç¢ºä¿ UI åœ¨ä»»ä½•ç’°å¢ƒä¸‹ï¼Œ0.01ç§’å…§å¿…å®šå…ˆå®Œæˆå–®æ©Ÿç‰ˆå•Ÿå‹• ---
    window.initializeEmptyDb = function() {
        window.db = { students: [], stockPrices: {}, lastWeekChanges: {}, transactions: [] };
        for (let i = 1; i <= 27; i++) window.db.students.push({ id: i.toString(), name: '', group: '' });
        for (let i = 1; i <= 7; i++) { window.db.stockPrices[i.toString()] = 2000; window.db.lastWeekChanges[i.toString()] = 0; }
        window.db.stockPrices['00504'] = 2000; window.db.lastWeekChanges['00504'] = 0;
    };

    window.loadOfflineData = function() {
        const stored = localStorage.getItem('504_stock_exchange_v5');
        if (stored) window.db = JSON.parse(stored);
        else window.initializeEmptyDb();
        window.updateAllUI();
    };

    window.saveDataToCloud = function() {
        localStorage.setItem('504_stock_exchange_v5', JSON.stringify(window.db));
        window.updateAllUI();
    };

    window.updateAllUI = function() {
        if(window.renderRosterDND) window.renderRosterDND();
        if(window.renderFastBuyerGrid) window.renderFastBuyerGrid();
        if(window.renderTransactionsMerged) window.renderTransactionsMerged();
        if(document.getElementById('kiosk-mode').style.display === 'block' && window.renderKioskGrid) window.renderKioskGrid();
        if(window.currentFastBuyerId && window.updateQuotaDisplay) window.updateQuotaDisplay();
    };

    // --- åœ¨ç¬¬ä¸€æ™‚é–“ç«‹åˆ»åŸ·è¡Œï¼Œç ´è§£ç™½ç•«é¢èˆ‡æ­»æŒ‰éˆ• ---
    initDropdown();
    window.loadOfflineData();
</script>

<!-- ================= Firebase é›²ç«¯æ ¸å¿ƒé‚è¼¯ (èƒŒæ™¯æ¼¸é€²å¼å¢å¼·) ================= -->
<script type="module">
    const MY_GITHUB_FIREBASE_CONFIG = {
        apiKey: "AIzaSyDJFzG3RrCkJBx5B23lBVcoOHmaqZ2dAYA", 
        authDomain: "forgemini-7349a.firebaseapp.com",
        projectId: "forgemini-7349a",
        storageBucket: "forgemini-7349a.firebasestorage.app",
        messagingSenderId: "865250968546",
        appId: "1:865250968546:web:fc3ded71179b709d422fbb"
    };

    let firebaseConfig = MY_GITHUB_FIREBASE_CONFIG;
    let appIdStr = '504-stock-exchange';

    let firestoreDb;
    let auth;
    let fsDoc, fsSetDoc, fsOnSnapshot; 

    function setupRealtimeSync() {
        if (!auth || !auth.currentUser || !fsDoc || !fsOnSnapshot) return;
        const docRef = fsDoc(firestoreDb, 'artifacts', appIdStr, 'public', 'data', 'exchangeData', 'main');

        fsOnSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                window.db = docSnap.data();
                document.getElementById('sync-indicator').classList.add('synced'); 
                document.getElementById('sync-text').textContent = ' STATUS: é›²ç«¯å³æ™‚åŒæ­¥ä¸­ (Online)';
                window.updateAllUI();
            } else {
                window.initializeEmptyDb();
                window.saveDataToCloud();
            }
        }, (error) => {
            console.error("é›²ç«¯é€£ç·šç•°å¸¸:", error);
            document.getElementById('sync-indicator').classList.remove('synced');
        });
    }

    async function initFirebase() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('mode') === 'kiosk') {
            window.isStrictKiosk = true;
            document.getElementById('kiosk-exit-btn').style.display = 'none'; 
            window.toggleKioskMode(true);
        }

        try {
            const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
            const { getAuth, signInAnonymously, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
            const { getFirestore, doc, onSnapshot, setDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
            
            fsDoc = doc; fsSetDoc = setDoc; fsOnSnapshot = onSnapshot;
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            firestoreDb = getFirestore(app);

            // æˆåŠŸé€£ç·šå¾Œï¼Œè¦†å¯«å­˜æª”æ©Ÿåˆ¶ï¼šä¸åƒ…å­˜æœ¬æ©Ÿï¼Œé‚„å³æ™‚ä¸Šå‚³é›²ç«¯
            window.saveDataToCloud = async function() {
                localStorage.setItem('504_stock_exchange_v5', JSON.stringify(window.db));
                if (auth && auth.currentUser && fsDoc && fsSetDoc) {
                    try {
                        const dRef = fsDoc(firestoreDb, 'artifacts', appIdStr, 'public', 'data', 'exchangeData', 'main');
                        await fsSetDoc(dRef, window.db);
                    } catch (e) { console.error("åŒæ­¥å¤±æ•—", e); }
                }
                window.updateAllUI();
            };

            await signInAnonymously(auth);
            onAuthStateChanged(auth, (user) => {
                if (user) setupRealtimeSync();
            });

        } catch (e) {
            console.log("Firebase æ¨¡çµ„é­é˜»æ“‹æˆ–æœªé€£ç·šï¼Œç¹¼çºŒç¶­æŒå–®æ©Ÿç‰ˆé‹ä½œã€‚", e);
            document.getElementById('sync-indicator').classList.remove('synced');
            document.getElementById('sync-text').textContent = ' STATUS: å–®æ©Ÿæ¸¬è©¦æ¨¡å¼ (Offline)';
        }
    }

    // å»¶é² 500ms å•Ÿå‹•é›²ç«¯é€£ç·šï¼Œç¢ºä¿ä¸æœƒå¹²æ“¾ç•«é¢æ¸²æŸ“
    setTimeout(initFirebase, 500);
</script>
</body>
</html>
